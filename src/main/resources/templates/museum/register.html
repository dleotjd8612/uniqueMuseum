<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <title>aaa</title>
    <style>
        .uploadResult {
        width: 100%;
        background-color: gray;
        margin-top: 10px;
    }
    .uploadResult ul {
        display: flex;
        flex-flow: row;
        justify-content: center;
        align-items: center;
        vertical-align: top;
        overflow: auto;
    }
    .uploadResult ul li {
        list-style: none;
        padding: 10px;
        margin-left: 2em;
    }
    .uploadResult ul li img {
        width: 100px;
    }
    </style>
</head>
<body>
    <th:block th:replace="~{layout/basic::setContent(~{this::content})}">
        <th:block th:fragment="content">
            <h1 class="mt-4">박물관 등록</h1><br>

            <form th:action="@{/museum/register}" th:method="post">
                <div class="form-group">
                    <label>박물관 이름</label>
                    <input type="text" class="form-control" name="name" placeholder="박물관명을 입력하시오.">
                </div>

                <!-- 박물관 정보 추가 해야 함 -->
                <div class="form-group">
                    <label>박물관 주소</label>
                    <input type="text" class="form-control" name="address" placeholder="박물관 주소를 입력하시오.">
                </div>
                <div class="form-group">
                    <label>박물관 전화번호</label>
                    <input type="text" class="form-control" name="number" placeholder="박물관 전화번호를 입력하시오.">
                </div>
                <div class="form-group">
                    <label>편의 시설 정보</label>
                    <input type="text" class="form-control" name="convenienceFacilityInformation" placeholder="편의 시설 정보를 입력하시오.">
                </div>
                <div class="form-group">
                    <label>평일 운영 시간</label>
                    <input type="time" class="form-control" name="weekdaysOpen" value="09:00">
                    <input type="time" class="form-control" name="weekdaysClose" value="18:00">
                </div>
                <div class="form-group">
                    <label>주말 운영 시간</label>
                    <input type="time" class="form-control" name="weekendOpen" value="09:00">
                    <input type="time" class="form-control" name="weekendClose" value="18:00">
                </div>
                <div class="form-group">
                    <label>휴관 정보</label>
                    <input type="text" class="form-control" name="closingInformation" placeholder="휴관 정보를 입력하시오.">
                </div>
                <div class="form-group">
                    <label>성인 관람료</label>
                    <input type="text" class="form-control" name="adultAdmissionFee" pattern="[0-9]+" th:value="0" placeholder="금액을 입력하시오.">
                </div>
                <div class="form-group">
                    <label>청소년 관람료</label>
                    <input type="text" class="form-control" name="teenagerAdmissionFee" pattern="[0-9]+" th:value="0" placeholder="금액을 입력하시오.">
                </div>
                <div class="form-group">
                    <label>어린이 관람료</label>
                    <input type="text" class="form-control" name="childrenAdmissionFee" pattern="[0-9]+" th:value="0" placeholder="금액을 입력하시오.">
                </div>
                <div class="form-group">
                    <label>관람료 정보</label>
                    <input type="text" class="form-control" name="admissionFeeInformation" placeholder="관람료 정보를 입력하시오.">
                </div>

                <div class="form-group fileForm">
                    <label>이미지 파일</label>
                    <div class="custom-file">
                        <input type="file" class="custom-file-input files" id="fileInput" multiple>
                        <label class="custom-file-label" data-browse="Browse"></label>
                    </div>
                </div>

                <div class="box">

                </div>

                <button type="submit" class="btn btn-primary">전송</button>

                <div class="uploadResult">
                    <ul>

                    </ul>
                </div>
            </form>

            <script>
                $(document).ready(function (e) {
                    var regex = new RegExp("(.*?)\.(exe|sh|zip|alz|tiff)$");
                    var maxSize = 10485760; // 10MB

                    function checkExtension(fileName, fileSize) {
                        if(fileSize >= maxSize) {
                            alert("파일 사이즈 초과");
                            return false;
                        }
                        if(regex.test(fileName)) {
                            alert("해당 종류의 파일은 업로드할 수 없습니다.");
                            return false;
                        }
                        return true;
                    }

                    $(".custom-file-input").on("change", function () {
                        var fileName = $(this).val().split("\\").pop();
                        $(this).siblings(".custom-file-label").addClass("selected").html(fileName);

                        var formData = new FormData();
                        var inputFile = $(this);
                        var files = inputFile[0].files;
                        var appended = false;

                        for(var i = 0; i < files.length; i++) {
                            if(!checkExtension(files[i].name, files[i].size)) {
                                return false;
                            }
                            console.log(files[i]);
                            formData.append("uploadFiles", files[i]);
                            appended = true;
                        }

                        // upload를 하지 않는다.
                        if(!appended) {return;}

                        for(var value of formData.values()) {
                            console.log(value);
                        }

                        //실제 업로드 부분
                        //upload ajax
                        $.ajax({
                           url: '/uploadAjax',
                           processData: false,
                           contentType: false,
                           data: formData,
                           type: 'POST',
                           dataType: 'json',
                           success: function (result) {
                               console.log(result);
                               showResult(result);
                           },
                            error: function (jqXHR, textStatus, errorThrown) {
                               console.log(textStatus);
                            }
                        });
                    });

                    // 이미지 업로드 시 이미지 보이기
                    function showResult(uploadResultArr) {
                        var uploadUL = $(".uploadResult ul");
                        var str = "";
                        $(uploadResultArr).each(function (i, obj) {
                            str += "<li data-name='" + obj.fileName + "' data-path='" + obj.folderPath + "' data-uuid='" + obj.uuid + "'>";
                            str += " <div>";
                            str += "<button type='button' data-file=\'" + obj.imageURL + "\' ";
                            str += "class='btn-warning btn-sm'>X</button><br>";
                            str += "<img src='/display?fileName=" + obj.thumbnailURL + "'>";
                            str += "</div>";
                            str += "</li>";
                        });
                        uploadUL.append(str);
                    }

                    // 이미지 파일의 삭제와 submit 처리
                    $(".uploadResult").on("click", "li button", function (e) {
                        console.log("delete file");
                        var targetFile = $(this).data("file");
                        var targetLi = $(this).closest("li");

                        $.ajax({
                            url: '/removeFile',
                            data: {fileName: targetFile},
                            dataType: 'text',
                            type: 'POST',
                            success: function (result) {
                                alert(result);
                                targetLi.remove();
                            }
                        });
                    });

                });
            </script>
        </th:block>
    </th:block>
</body>
</html>